# Домашнее задание к занятию 6. «Troubleshooting» - `Мальцев Виктор`

---

Задача 1

Перед выполнением задания ознакомьтесь с документацией по администрированию MongoDB.

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD-операция в MongoDB и её нужно прервать.

Вы как инженер поддержки решили произвести эту операцию:

    напишите список операций, которые вы будете производить для остановки запроса пользователя;
    предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.

Ответ:

Для остановки долгой CRUD-операции в MongoDB будут предприняты следующие шаги:

    1. Вход в mongo shell: Используется консоль для входа в mongo shell с помощью команды mongo.

    2. Подключение к базе данных: Подключение к нужной базе данных с командой use <database_name>.

    3. Проверка текущих операций: Используется команда db.currentOp() для просмотра всех текущих операций и их идентификаторов (opid).

    4. Идентификация зависшей операции: Находится операция, которую необходимо прервать, обратив внимание на время начала, идентификатор операции и другую информацию.

    5. Остановка операции: Используется команда db.killOp(<opid>) для остановки операции с определенным идентификатором.

    6. Проверка статуса операции: Снова применяется db.currentOp() для проверки, что операция была успешно прервана.

    7. Запись инцидента: Вся информация о произошедшем инциденте записывается для последующего анализа и предотвращения подобных проблем.

Чтобы решить проблему с долгими или зависающими запросами в MongoDB, предлагаются следующие меры:

    1. Оптимизация запросов: Проверка использования индексов и создание соответствующих индексов при необходимости.

    2. Мониторинг и анализ производительности: Использование инструментов мониторинга, таких как MongoDB Atlas, для выявления медленных запросов.

    3. Настройка времени ожидания: Установка максимального времени выполнения для запросов.

    4. Вертикальное масштабирование: Рассмотрение увеличения ресурсов сервера при высокой нагрузке.

    5. Горизонтальное масштабирование: Шардирование данных на несколько серверов.

    6. Оптимизация схемы данных: Пересмотр структуры данных и модели документов.

    7. Обучение и рекомендации для разработчиков: Проведение обучения и предоставление рекомендаций по оптимизации запросов.

    8. Кэширование: Использование кэширования для часто запрашиваемых данных.

---

Задача 2

Перед выполнением задания познакомьтесь с документацией по Redis latency troobleshooting.

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. Причём отношение количества записанных key-value-значений к количеству истёкших значений есть величина постоянная и увеличивается пропорционально количеству реплик сервиса.

При масштабировании сервиса до N реплик вы увидели, что:

    сначала происходит рост отношения записанных значений к истекшим,
    Redis блокирует операции записи.

Как вы думаете, в чём может быть проблема?

Ответ:

Проблема, может быть связана с высокой задержкой (latency) и блокировками в Redis, особенно при использовании механизма TTL (Time to Live) для ключей. Поскольку отношение количества записанных key-value-значений к количеству истекших значений увеличивается пропорционально количеству реплик сервиса, возможные причины следующие:

    1. Повышенная нагрузка на Redis: При масштабировании сервиса до N реплик, каждая реплика может добавлять дополнительную нагрузку на Redis. Если нагрузка становится слишком высокой, это может привести к увеличению задержки и блокировке операций записи.

    2. Избыточное использование памяти: Redis работает в памяти, и если ключи с TTL занимают слишком много памяти, это может привести к проблемам с производительностью. Redis может пытаться освободить память, удаляя истекшие ключи, но при высокой нагрузке этот процесс может не успевать справляться.

    3. Проблемы с процессом удаления истекших ключей: Redis периодически удаляет истекшие ключи в фоновом режиме. Однако, если ключей слишком много, процесс может стать менее эффективным, и это может вызывать задержку и блокировки.

    4. Конфигурация и настройки Redis: Некоторые настройки конфигурации Redis, такие как maxmemory-policy, влияют на то, как Redis управляет памятью и удаляет ключи. Неправильная конфигурация может привести к проблемам с производительностью.


Чтобы решить эту проблему нужно предпринять следующие шаги:

    1. Мониторинг и анализ производительности Redis: Используем инструменты мониторинга, такие как redis-cli --latency, чтобы анализировать задержку и производительность.

    2. Оптимизация конфигурации Redis: Проверяем и оптимизируем параметры конфигурации Redis, такие как maxmemory и maxmemory-policy, чтобы лучше управлять памятью и процессом удаления ключей.

    3. Горизонтальное масштабирование Redis: Можно рассмотреть возможность использования Redis кластеров для распределения нагрузки между несколькими узлами и уменьшения нагрузки на отдельный инстанс Redis.

    4. Оптимизация TTL: Можно провести пересмотр использования TTL и возможно уменьшение времени жизни ключей, если это допустимо, или провести оптимизируйте процесс их устаревания.

    5. Рассмотрение использования асинхронного удаления ключей: В некоторых случаях можно рассмотреть использование асинхронного удаления ключей, чтобы уменьшить блокировку основного потока Redis.

    6. Оптимизация нагрузки на Redis: Оптимизация запросов, чтобы снизить нагрузку на Redis, возможно, используя более эффективные структуры данных или кэширование на стороне клиента.

После выполнения этих шагов, следует продолжать мониторить производительность Redis и адаптировать стратегии в соответствии с меняющимися требованиями и нагрузкой.

---

Задача 3

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей в таблицах базы пользователи начали жаловаться на ошибки вида:

InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения этой проблемы вы можете предложить?

Ответ:

Ошибки типа "Lost connection to MySQL server during query" могут происходить по разным причинам. Вот некоторые из них и способы локализации проблемы:

    1. Таймауты сети или сервера: Если запрос занимает слишком много времени, соединение может быть прервано из-за таймаута. Нужно проверить параметры wait_timeout и interactive_timeout в конфигурации MySQL. Также нужно проверить сетевые таймауты на уровне ОС и оборудования.

    2. Превышение лимитов ресурсов: Если сервер базы данных недостаточно мощный или неправильно настроен, это может привести к потере соединения. Нужно проверить загрузку процессора, использование памяти и дисковую активность на сервере MySQL.

    3. Проблемы с сетевым подключением: Нестабильное сетевое соединение между клиентом и сервером MySQL может привести к потере соединения. Нужно проверить стабильность сети и возможные проблемы с маршрутизацией.

    4. Ошибки в запросах: Некоторые запросы могут быть слишком сложными или неоптимальными, что приводит к долгому времени выполнения и, как результат, к разрыву соединения. Нужно проверить журналы ошибок MySQL и провести анализ выполнения запросов.

    5. Ограничения на размер пакетов: Параметр max_allowed_packet определяет максимальный размер пакета, который может быть передан между клиентом и сервером. Если запрос или результат слишком велик, это может привести к потере соединения.

Для решения этой проблемы, рекомендуется предпринять следующие шаги:

    1. Оптимизация запросов: Пересмотр и оптимизация SQL-запросов, чтобы уменьшить их сложность и улучшить производительность.

    2. Настройка параметров сервера: Настройка параметров MySQL, таких как wait_timeout, interactive_timeout и max_allowed_packet, чтобы они соответствовали требованиям приложения.

    3. Масштабирование ресурсов сервера: Если проблема связана с ограниченными ресурсами, можно рассмотреть возможность увеличения ресурсов сервера (например, памяти, процессора) или горизонтального масштабирования с использованием кластеров.

    4. Мониторинг и анализ сети: Проверка и мониторингсетевых соединений, чтобы обеспечить их стабильность и надежность. Возможно, потребуется работа с сетевыми администраторами или провайдерами услуг для решения сетевых проблем.

    5. Использование пулов соединений: Можно использовать пулы соединений, чтобы уменьшить нагрузку на сервер базы данных, повторно используя соединения, а не устанавливая новое соединение для каждого запроса.

    6. Логирование и мониторинг: Нужно включить логирование на сервере MySQL и провести анализ журналов на предмет ошибок или предупреждений, которые могут указывать на причину потери соединения.

Применяя эти шаги, можно не только локализовать проблему, но и предпринять меры по её решению, чтобы обеспечить стабильную и высокопроизводительную работу базы данных MySQL в гис-системе.
---

Задача 4

Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с большим объёмом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

postmaster invoked oom-killer

Как вы думаете, что происходит?

Как бы вы решили эту проблему?


Ответ:

Сообщение "postmaster invoked oom-killer" указывает на то, что процесс PostgreSQL (postmaster) вызвал "oom-killer" (Out of Memory Killer) в операционной системе. Это происходит, когда системе не хватает памяти, и она пытается автоматически освободить ресурсы, завершая один или несколько процессов. В данном случае, это может означать, что СУБД PostgreSQL потребляет слишком много памяти, влекущее за собой нехватку ресурсов и, как результат, недоступность базы данных.

Вот некоторые шаги, которые можно предпринять для решения этой проблемы:

    1. Мониторинг использования памяти: Сначала необходимо мониторить и анализировать использование памяти на сервере. Это поможет определить, является ли потребление памяти PostgreSQL основной причиной проблемы.

    2. Настройка параметров PostgreSQL: PostgreSQL имеет множество параметров, влияющих на использование памяти, таких как shared_buffers, work_mem и maintenance_work_mem. Необходимо тщательно настроить эти параметры в соответствии с ресурсами сервера и требованиями гис-системы.

    3. Оптимизация запросов: Неэффективные или сложные запросы могут потреблять большое количество памяти. Нужно оптимизировать SQL-запросы, чтобы уменьшить их потребление ресурсов.

    4. Масштабирование ресурсов сервера: Если сервер имеет ограниченные ресурсы памяти, можно рассмотреть возможность увеличения объема оперативной памяти или использования более мощного оборудования.

    5. Настройка ОС: Возможно, потребуется настроить параметры ОС, связанные с управлением памятью, такие как vm.overcommit_memory и vm.swappiness. Также можно рассмотреть возможность настройки ограничений на использование памяти для процессов PostgreSQL с использованием cgroups.

    6. Регулярное резервное копирование и обслуживание: Нужно проводить регулярное резервное копирование и обслуживание базы данных для оптимизации производительности и предотвращения утечек памяти.

    7. Мониторинг и логирование: Нужно включить логирование и мониторинг PostgreSQL, чтобы быстро выявлять проблемы и реагировать на них.

Путем комбинирования этих шагов, можно оптимизировать использование памяти PostgreSQL, улучшить стабильность и производительность гис-системы, а также предотвратить ситуации, когда СУБД становится недоступной из-за нехватки памяти.